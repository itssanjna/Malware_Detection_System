import pyclamd
from django.conf import settings

def get_clamd_connection():
    cd = pyclamd.ClamdUnixSocket(settings.CLAMAV_SOCKET)
    try:
        cd.ping()
    except pyclamd.ConnectionError:
        raise Exception("Could not connect to ClamAV daemon.")

    return cd

def scan_file_with_clamav(file_path):
    cd = get_clamd_connection()
    scan_result = cd.scan_file(file_path)

    if scan_result is None:
        return {'status': 'clean'}

    filename, scan_info = next(iter(scan_result.items()))
    if scan_info[0] == 'FOUND':
        return {'status': 'infected', 'malware_name': scan_info[1]}
    else:
        return {'status': 'error', 'message': 'Unknown ClamAV result'}
